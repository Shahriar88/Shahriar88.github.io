<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>URDF Viewer</title>
  <style>
    html,body{height:100%;margin:0} #viewport{position:fixed;inset:0}
    #ui{position:fixed;top:12px;left:12px;right:12px;max-width:420px;background:rgba(255,255,255,.85);
        backdrop-filter:blur(6px);padding:12px;border-radius:14px;box-shadow:0 6px 24px rgba(0,0,0,.15);
        font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Arial}
    #sliders{max-height:40vh;overflow:auto} .row{display:grid;grid-template-columns:1fr auto;gap:8px;align-items:center;margin:6px 0}
  </style>
</head>
<body>
  <canvas id="viewport"></canvas>
  <div id="ui">
    <h3>URDF Viewer</h3>
    <div>Default path: <code>assets/robot.urdf</code> (commit your URDF & meshes there).</div>
    <div class="row" style="margin-top:6px">
      <input id="urdfPath" type="text" value="assets/robot.urdf" style="width:260px">
      <button id="loadBtn">Load</button>
    </div>
    <div id="sliders"></div>
  </div>

  <script type="module">
    import * as THREE from 'https://unpkg.com/three@0.159.0/build/three.module.js';
    import { OrbitControls } from 'https://unpkg.com/three@0.159.0/examples/jsm/controls/OrbitControls.js';
    import { STLLoader } from 'https://unpkg.com/three@0.159.0/examples/jsm/loaders/STLLoader.js';
    import { ColladaLoader } from 'https://unpkg.com/three@0.159.0/examples/jsm/loaders/ColladaLoader.js';
    import URDFLoader from 'https://unpkg.com/urdf-loader@0.10.3/src/URDFLoader.js';

    // Scene
    const canvas = document.getElementById('viewport');
    const renderer = new THREE.WebGLRenderer({canvas, antialias:true});
    const scene = new THREE.Scene(); scene.background = new THREE.Color(0xf6f7fb);
    const camera = new THREE.PerspectiveCamera(45, 2, 0.01, 1000); camera.position.set(2.5,1.5,3.5);
    const controls = new OrbitControls(camera, renderer.domElement); controls.target.set(0,0.5,0); controls.update();
    const hemi = new THREE.HemisphereLight(0xffffff, 0x444444, 0.9); scene.add(hemi);
    const dir = new THREE.DirectionalLight(0xffffff, 0.8); dir.position.set(5,5,5); scene.add(dir);
    const grid = new THREE.GridHelper(10,20,0x888888,0xdddddd); scene.add(grid);
    function onResize(){ const w=innerWidth,h=innerHeight; renderer.setSize(w,h,false); camera.aspect=w/h; camera.updateProjectionMatrix(); }
    addEventListener('resize', onResize); onResize();

    const loader = new URDFLoader();
    loader.packages = { '': 'assets/' }; // maps package:// to /urdf/
    loader.loadMeshCb = (path, manager, done) => {
      const ext = path.split('.').pop().toLowerCase();
      if (ext==='stl') new STLLoader(manager).load(path, geo => done(new THREE.Mesh(geo, new THREE.MeshStandardMaterial({color:0x9aa3b2, metalness:0.1, roughness:0.6}))));
      else if (ext==='dae') new ColladaLoader(manager).load(path, collada => done(collada.scene));
      else done(); // let urdf-loader try others
    };

    let robot;
    function buildSliders(){
      const wrap = document.getElementById('sliders'); wrap.innerHTML = '';
      if (!robot || !robot.joints) return;
      Object.entries(robot.joints).forEach(([name,j])=>{
        if (!['revolute','continuous','prismatic'].includes(j.type)) return;
        const row=document.createElement('div'); row.className='row';
        const label=document.createElement('label'); label.textContent=`${name} (${j.type})`; row.appendChild(label);
        const input=document.createElement('input'); input.type='range';
        const lim=j.limits||{lower:-Math.PI,upper:Math.PI}; const prism=j.type==='prismatic';
        input.min=prism?(lim.lower??-0.1):(lim.lower??-Math.PI);
        input.max=prism?(lim.upper?? 0.1):(lim.upper?? Math.PI);
        input.step=prism?0.001:0.01; input.value=j.angle||0;
        input.oninput=e=>{const v=parseFloat(e.target.value); prism?j.setPosition(v):j.setJointValue(v);};
        row.appendChild(input); wrap.appendChild(row);
      });
    }
    function frameFit(obj){
      const box=new THREE.Box3().setFromObject(obj), size=box.getSize(new THREE.Vector3()).length(), c=box.getCenter(new THREE.Vector3());
      controls.target.copy(c); controls.update(); camera.position.copy(c).add(new THREE.Vector3(size*0.6,size*0.4,size*0.8)); camera.lookAt(c);
    }
    async function loadURDF(path){
      if (robot) { scene.remove(robot); }
      loader.load(path, r => { robot=r; scene.add(robot); frameFit(robot); buildSliders(); });
    }
    document.getElementById('loadBtn').onclick = ()=> loadURDF(document.getElementById('urdfPath').value.trim());
    loadURDF(document.getElementById('urdfPath').value);

    (function animate(){ requestAnimationFrame(animate); renderer.render(scene,camera); })();
  </script>
</body>
</html>
