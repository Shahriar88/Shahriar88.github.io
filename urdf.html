<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>URDF Viewer â€” Simple Clone</title>
<style>
  :root { --card:#fff; --muted:#667085; --ring:#e5e7eb; --shadow:0 6px 24px rgba(0,0,0,.12) }
  html,body{height:100%;margin:0}
  #viewport{position:fixed;inset:0;background:#f6f7fb}
  #ui{
    position:fixed;top:12px;left:12px;right:12px;max-width:980px;margin:0 auto;
    background:rgba(255,255,255,.92);backdrop-filter:blur(6px);
    padding:14px;border-radius:16px;box-shadow:var(--shadow);font:14px/1.4 ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Arial
  }
  h3{margin:0 0 10px;font-size:22px}
  .row{display:flex;flex-wrap:wrap;gap:8px;align-items:center;margin:6px 0}
  .btn{appearance:none;border:1px solid var(--ring);background:#fff;border-radius:12px;padding:8px 12px;cursor:pointer}
  .btn:active{transform:translateY(1px)}
  .pill{border:1px solid var(--ring);border-radius:999px;padding:6px 10px;background:#fff}
  input[type="text"],input[type="url"]{border:1px solid var(--ring);border-radius:12px;padding:8px 10px;min-width:320px}
  textarea{width:100%;min-height:120px;border:1px solid var(--ring);border-radius:12px;padding:8px 10px;font-family:monospace}
  #sliders{max-height:36vh;overflow:auto;border-top:1px dashed var(--ring);padding-top:8px;margin-top:8px}
  .slider{display:grid;grid-template-columns: 1fr minmax(160px,320px) 60px;gap:10px;align-items:center;margin:6px 0}
  .muted{color:var(--muted)}
  #err{margin-top:6px;color:#b00020;white-space:pre-wrap}
  .drop{outline:2px dashed var(--ring);outline-offset:6px;border-radius:12px;padding:6px 10px}
  .right{margin-left:auto}
</style>
</head>
<body>
<canvas id="viewport"></canvas>

<div id="ui">
  <h3>URDF Viewer</h3>

  <div class="row">
    <button class="btn" id="resetView">Reset view</button>
    <label class="pill"><input type="checkbox" id="axisT" checked> Axis helper</label>
    <label class="pill"><input type="checkbox" id="wireT"> Wireframe</label>
    <button class="btn" id="frontView">Front</button>
    <button class="btn" id="topView">Top</button>
    <button class="btn" id="sideView">Side</button>
    <button class="btn" id="screenshot" title="Save PNG">ðŸ“¸ Screenshot</button>
    <span class="right muted">Auto: <code>assets/robot.urdf</code></span>
  </div>

  <div class="row">
    <input type="url" id="urlInput" placeholder="https://â€¦/robot.urdf" />
    <button class="btn" id="loadUrl">Load URL</button>
    <input type="file" id="fileInput" accept=".urdf" />
    <button class="btn" id="loadLocal">Load file</button>
    <button class="btn" id="loadDefault">Load assets/robot.urdf</button>
  </div>

  <div class="row drop" id="dropZone">Drop a .urdf file here</div>

  <div class="row" style="width:100%">
    <textarea id="urdfText" placeholder="Paste URDF hereâ€¦"></textarea>
  </div>
  <div class="row">
    <button class="btn" id="loadText">Load from pasted URDF</button>
    <span class="muted">Tip: paste the exact XML you tested on mymodelrobot.</span>
  </div>

  <div id="sliders"></div>
  <div id="err"></div>
</div>


<script type="importmap">
{
  "imports": {
    "three": "https://cdn.jsdelivr.net/npm/three@0.159.0/build/three.module.js"
  }
}
</script>



  

<script type="module">
  import * as THREE from 'https://cdn.jsdelivr.net/npm/three@0.159.0/build/three.module.js';
  import { OrbitControls } from 'https://cdn.jsdelivr.net/npm/three@0.159.0/examples/jsm/controls/OrbitControls.js';
  import URDFLoader from 'https://cdn.jsdelivr.net/npm/urdf-loader@0.10.3/build/URDFLoader.js';

  // ----- three.js scene -----
  const canvas = document.getElementById('viewport');
  const renderer = new THREE.WebGLRenderer({ canvas, antialias: true, preserveDrawingBuffer:true });
  renderer.setPixelRatio(Math.min(2, window.devicePixelRatio));
  const scene = new THREE.Scene(); scene.background = new THREE.Color(0xf6f7fb);
  const camera = new THREE.PerspectiveCamera(45, 2, 0.01, 1000);
  camera.position.set(2.5, 1.6, 3.8);

  const controls = new OrbitControls(camera, renderer.domElement);
  controls.target.set(0, 0.5, 0); controls.update();

  const hemi = new THREE.HemisphereLight(0xffffff, 0x444444, 0.9);
  const dir  = new THREE.DirectionalLight(0xffffff, 0.85); dir.position.set(5,5,5);
  scene.add(hemi, dir);
  const grid = new THREE.GridHelper(10, 20, 0x999999, 0xdddddd); scene.add(grid);
  const axisHelper = new THREE.AxesHelper(0.25); axisHelper.visible = true; scene.add(axisHelper);

  function onResize(){
    const w = innerWidth, h = innerHeight;
    renderer.setSize(w, h, false); camera.aspect = w / h; camera.updateProjectionMatrix();
  }
  addEventListener('resize', onResize); onResize();

  // ----- loader -----
  const loader = new URDFLoader();
  // Map package:// URIs (if your URDF uses them) to /assets/
  loader.packages = { '': 'assets/' };

  let robot, baseMat;
  const slidersDiv = document.getElementById('sliders');
  const err = (m)=> document.getElementById('err').textContent = m || '';

  function frameFit(obj){
    const box = new THREE.Box3().setFromObject(obj);
    const size = Math.max(0.5, box.getSize(new THREE.Vector3()).length());
    const c = box.getCenter(new THREE.Vector3());
    controls.target.copy(c); controls.update();
    camera.position.copy(c).add(new THREE.Vector3(size*0.7, size*0.45, size*0.9));
    camera.lookAt(c);
  }

  function buildSliders(){
    slidersDiv.innerHTML = '';
    if (!robot?.joints) return;
    Object.entries(robot.joints).forEach(([name, j])=>{
      if (!['revolute','continuous','prismatic'].includes(j.type)) return;
      const row = document.createElement('div'); row.className = 'slider';
      const lbl = document.createElement('div'); lbl.textContent = `${name} (${j.type})`; row.appendChild(lbl);
      const rng = document.createElement('input'); rng.type='range';
      const lim = j.limits || { lower:-Math.PI, upper: Math.PI };
      const prism = j.type==='prismatic';
      rng.min = prism ? (lim.lower ?? -0.1) : (lim.lower ?? -Math.PI);
      rng.max = prism ? (lim.upper ??  0.1) : (lim.upper ??  Math.PI);
      rng.step = prism ? 0.001 : 0.01;
      rng.value = j.angle || 0;
      rng.oninput = e => { const v = parseFloat(e.target.value); prism ? j.setPosition(v) : j.setJointValue(v); };
      const val = document.createElement('div');
      const updateVal = () => val.textContent = prism ? `${(+rng.value).toFixed(3)} m` : `${(+rng.value).toFixed(2)} rad`;
      rng.addEventListener('input', updateVal); updateVal();
      row.appendChild(rng); row.appendChild(val);
      slidersDiv.appendChild(row);
    });
  }

  function setWireframe(on) {
    if (!robot) return;
    robot.traverse(obj=>{
      if (obj.isMesh) {
        (obj.material ??= new THREE.MeshStandardMaterial()).wireframe = !!on;
      }
    });
  }

  function resetView(){
    if (robot) frameFit(robot);
    controls.reset(); controls.update();
  }

  function loadFromDOMString(xmlString, resourcePath='assets/'){
    try {
      err('');
      if (robot) scene.remove(robot);
      loader.parse(
        xmlString,
        resourcePath,
        r => { robot = r; scene.add(robot); frameFit(robot); buildSliders(); setWireframe(document.getElementById('wireT').checked); },
        e => err('URDF parse error: ' + (e?.message || e))
      );
    } catch (e) {
      err(e.message || String(e));
      console.error(e);
    }
  }

  async function loadFromURL(url){
    try {
      err(''); const res = await fetch(url, { cache: 'no-store' });
      if (!res.ok) throw new Error(`HTTP ${res.status} for ${url}`);
      const txt = await res.text();
      loadFromDOMString(txt, new URL(url, location.href).href.replace(/[^/]+$/,''));
    } catch(e){ err(e.message || String(e)); }
  }

  function loadDefault(){ loadFromURL('assets/robot.urdf'); }

  // ----- UI bindings -----
  document.getElementById('axisT').onchange = e => axisHelper.visible = e.target.checked;
  document.getElementById('wireT').onchange = e => setWireframe(e.target.checked);
  document.getElementById('resetView').onclick = resetView;

  document.getElementById('frontView').onclick = () => { if (!robot) return; const t=controls.target.clone(); camera.position.set(t.x, t.y, t.z + 3); camera.lookAt(t); };
  document.getElementById('topView').onclick   = () => { if (!robot) return; const t=controls.target.clone(); camera.position.set(t.x, t.y + 3, t.z); camera.lookAt(t); };
  document.getElementById('sideView').onclick  = () => { if (!robot) return; const t=controls.target.clone(); camera.position.set(t.x + 3, t.y, t.z); camera.lookAt(t); };

  document.getElementById('screenshot').onclick = () => {
    const a = document.createElement('a');
    a.download = 'urdf_view.png';
    a.href = renderer.domElement.toDataURL('image/png');
    a.click();
  };

  document.getElementById('loadUrl').onclick = () => {
    const u = document.getElementById('urlInput').value.trim();
    if (u) loadFromURL(u);
  };
  document.getElementById('loadDefault').onclick = loadDefault;

  document.getElementById('loadText').onclick = () => {
    const txt = document.getElementById('urdfText').value.trim();
    if (txt) loadFromDOMString(txt, 'assets/');
  };

  document.getElementById('loadLocal').onclick = () => document.getElementById('fileInput').click();
  document.getElementById('fileInput').onchange = async (e)=>{
    const f = e.target.files?.[0]; if (!f) return;
    const txt = await f.text(); loadFromDOMString(txt, 'assets/');
  };

  // drag & drop
  const dz = document.getElementById('dropZone');
  ;['dragenter','dragover'].forEach(ev=> dz.addEventListener(ev, e=>{e.preventDefault(); dz.style.background='#fafafa'}));
  ;['dragleave','drop'].forEach(ev=> dz.addEventListener(ev, e=>{e.preventDefault(); dz.style.background='transparent'}));
  dz.addEventListener('drop', async e=>{
    const f = e.dataTransfer?.files?.[0]; if (!f) return;
    if (!/\.urdf$/i.test(f.name)) { err('Please drop a .urdf file'); return; }
    const txt = await f.text(); loadFromDOMString(txt, 'assets/');
  });

  // animate
  (function tick(){ requestAnimationFrame(tick); renderer.render(scene,camera); })();

  // auto-load default file if present
  loadDefault();
</script>
</body>
</html>
