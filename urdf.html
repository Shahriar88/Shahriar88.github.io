<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>URDF Viewer</title>
  <style>
    html,body{height:100%;margin:0}
    #viewport{position:fixed;inset:0}
    #ui{
      position:fixed;top:12px;left:12px;right:12px;max-width:660px;
      background:rgba(255,255,255,.9);backdrop-filter:blur(6px);
      padding:16px;border-radius:16px;box-shadow:0 10px 30px rgba(0,0,0,.15);
      font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Arial
    }
    .row{display:flex;gap:16px;align-items:center;flex-wrap:wrap}
    .pill{display:inline-flex;align-items:center;gap:10px;padding:10px 16px;border:1px solid #e5e7eb;border-radius:14px;background:#fff}
    .code{font-family:ui-monospace, SFMono-Regular, Menlo, monospace; padding:.15rem .4rem; border-radius:.4rem; background:#f3f4f6}
    #err{margin-top:10px;color:#b00020;font-size:12px;white-space:pre-wrap}
  </style>

  <!-- Import map so bare imports work on GitHub Pages -->
  <script type="importmap">
  {
    "imports": {
      "three": "https://unpkg.com/three@0.159.0/build/three.module.js",
      "three/examples/jsm/controls/OrbitControls.js": "https://unpkg.com/three@0.159.0/examples/jsm/controls/OrbitControls.js"
    }
  }
  </script>
</head>
<body>
  <canvas id="viewport"></canvas>
  <div id="ui">
    <div class="row" style="margin-bottom:10px">
      <h2 style="margin:0">URDF Viewer</h2>
      <div style="margin-left:auto">Auto-loading: <span class="code">assets/robot.urdf</span></div>
    </div>
    <div class="row">
      <button id="reset" class="pill">Reset view</button>
      <label class="pill"><input id="axis" type="checkbox" checked> Axis helper</label>
      <label class="pill"><input id="wire" type="checkbox" checked> Wireframe</label>
    </div>
    <div id="err"></div>
  </div>

  <script type="module">
    import * as THREE from 'three';
    import { OrbitControls } from 'three/examples/jsm/controls/OrbitControls.js';
    // URDFLoader from the upstream repo via jsDelivr (works on GH Pages)
    import URDFLoader from 'https://cdn.jsdelivr.net/gh/gkjohnson/urdf-loaders@master/javascript/URDFLoader.js';

    // --- Three.js scene ---
    const canvas = document.getElementById('viewport');
    const renderer = new THREE.WebGLRenderer({ canvas, antialias: true });
    renderer.setPixelRatio(Math.min(2, window.devicePixelRatio));
    const scene = new THREE.Scene(); scene.background = new THREE.Color(0xf6f7fb);
    const camera = new THREE.PerspectiveCamera(45, 2, 0.01, 1000); camera.position.set(2.5,1.5,3.5);
    const controls = new OrbitControls(camera, renderer.domElement); controls.target.set(0,0.5,0); controls.update();

    const hemi = new THREE.HemisphereLight(0xffffff, 0x444444, 0.9);
    const dir  = new THREE.DirectionalLight(0xffffff, 0.8); dir.position.set(5,5,5);
    scene.add(hemi, dir);

    const grid = new THREE.GridHelper(10, 20, 0x888888, 0xdddddd);
    scene.add(grid);

    const axisHelper = new THREE.AxesHelper(0.25);
    scene.add(axisHelper);

    function onResize(){
      const w = innerWidth, h = innerHeight;
      renderer.setSize(w, h, false); camera.aspect = w / h; camera.updateProjectionMatrix();
    }
    addEventListener('resize', onResize); onResize();

    // Toggle helpers
    document.getElementById('axis').onchange = e => axisHelper.visible = e.target.checked;
    let wireframeMat = new THREE.MeshStandardMaterial({ color: 0x9aa3b2, metalness:0.05, roughness:0.8, wireframe:true });
    document.getElementById('wire').onchange = e => setWireframe(e.target.checked);

    // --- URDF loader ---
    const loader = new URDFLoader();
    // If your URDF uses "package://", map it like this:
    loader.packages = { '': 'assets/' };

    let robot;
    function setWireframe(on){
      if (!robot) return;
      robot.traverse(obj=>{
        if (obj.isMesh) {
          if (on) {
            // clone to avoid mutating shared materials
            obj.userData._origMat = obj.material;
            obj.material = wireframeMat;
          } else if (obj.userData._origMat) {
            obj.material = obj.userData._origMat;
            delete obj.userData._origMat;
          }
        }
      });
    }

    function frameFit(obj){
      const box = new THREE.Box3().setFromObject(obj);
      const size = Math.max(1e-3, box.getSize(new THREE.Vector3()).length());
      const c    = box.getCenter(new THREE.Vector3());
      controls.target.copy(c); controls.update();
      camera.position.copy(c).add(new THREE.Vector3(size*0.6, size*0.4, size*0.8));
      camera.lookAt(c);
    }

    const showErr = (m)=> document.getElementById('err').textContent = m || '';

    function loadURDF(path){
      showErr('');
      if (robot) { scene.remove(robot); robot = null; }

      // You can also prefetch & sanitize here if needed; for your URDF itâ€™s fine to load directly:
      loader.load(
        path,
        r => { robot = r; scene.add(robot); frameFit(robot); setWireframe(document.getElementById('wire').checked); },
        undefined,
        e => showErr(`Failed to load ${path}: ${e?.message || e}`)
      );
    }

    document.getElementById('reset').onclick = () => frameFit(robot || grid);

    // Auto-load your file
    loadURDF('assets/robot.urdf');

    (function animate(){ requestAnimationFrame(animate); renderer.render(scene, camera); })();
  </script>
</body>
</html>
